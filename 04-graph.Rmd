
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) 
library(MASS) 
```

# グラフ

データをグラフで表現する方法について学ぶ。
  
データの傾向をグラフによって表現することを**可視化(visualization)**という。この章では，`ggplot2`パッケージを使って，データを可視化する方法について学んでいく。  
  
`ggplot2`も`tidyverse`パッケージに含まれている。まずは，`tidyverse`パッケージをロードしよう。

```{r, warning=FALSE, message=FALSE, eval=FALSE}
library(tidyverse) 
```



## なぜ可視化が重要か？

データを解析する際には，単に平均値など数値を確認するだけではなく，必ず**データの分布を確認する**習慣を身に着けよう。  
  
例えばデータに極端に高い値があったりする場合は，代表値として平均値を使うのは適切でないことがわかったりする。データが正規分布と違うかたちをしているか，データの中に外れ値はないかなど，分布の形状をデータ解析の前に確認しておくことは重要である。


## Rのグラフィック

Rには標準でグラフを作成するための関数がいくつか用意されている。  
`hist()`はヒストグラム，`plot()`は散布図，`boxplot()`は箱ひげ図を作成するための関数である。
  
```{r}

hist(iris$Sepal.Length) #ヒストグラムを作成する
plot(iris$Sepal.Length, iris$Sepal.Width) #散布図を作成する
boxplot(iris$Sepal.Length) #箱ひげ図を作成する

```

手っ取り早くデータの分布や相関を確認したい場合は，これらの関数を使えば十分である。
  
しかし，標準で入っている関数は出力されるグラフがきれいではなかったり（論文やレポートなどで報告するには不十分），自分の好みに合わせてグラフの体裁を変えることもできるがオプションの指定方法が複雑といったデメリットもある。作成できるグラフの種類も限られている。  
  
これに対し，グラフを作る機能に特化したパッケージとして`ggplot2`というパッケージが開発されている。以降では，`ggplot2`の基本的な使い方を解説する。  
  
## ggplot2の基本

早速，`ggplot2`を使ってグラフを作ってみよう。以下のプログラムを実行してみよう。


```{r}

p = ggplot2::ggplot() + 
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) + 
  labs(x = "Length of sepal", y = "Length of petal") 
p

```

プログラムの解説：  
  
`ggplot()`：初期設定。「ggplot2を使ってグラフを書きます」という意味。必ず書く。カッコの中には何も入れなくて良い。  
  
`geom_xxxx()`：グラフの種類の指定。必ず書く。`xxxx`には，グラフの種類を入力する。この例では，散布図を書くので`geom_point`を指定した。更に，カッコの中に必要な設定を記す。  
  
`data =`でグラフを描画するデータを指定する。  
更に，`aes()`のカッコの中に描画に必要な要素を指定する。`x=`と`y=`でそれぞれ， x軸とy軸に指定したい変数を指定する。点の大きさ，色，線の種類など，グラフの種類によって指定できる要素がある。  
  
オプション：上での例では，`labs()`でx軸やy軸のラベルを指定している。他にも，軸の値の範囲，軸のラベル，グラフの色の設定などをオプションで指定することができる。オプションを加えなくてもグラフは出力される。  
  
  
とりあえず，これらだけ知っておけば`ggplot2`でグラフを作れる。  

### 散布図

`geom_point`で作成できる。

```{r}

p = ggplot2::ggplot() + 
  geom_point(data=mpg, aes(x=cty, y=hwy, shape = fl)) 
p

```

この例では，`shape =`でグループを指定して，グループごとに点のかたちを変えた散布図を作成した。    
    
点が重なって見えにくい場合は，`geom_jitter`を使うとランダムのズレを生成して表示してくれる。


```{r}

p = ggplot2::ggplot() + 
  geom_jitter(data=mpg, aes(x=cty, y=hwy, shape = fl)) 
p

```

### ヒストグラム

`geom_histogram`で作成する。


```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() + 
  geom_histogram(data = iris, aes(x=Sepal.Length))  #xに，横軸にしたい変数を入れる。
p

p = ggplot2::ggplot() + 
  geom_histogram(data = iris, aes(x=Sepal.Length, fill = Species))  #種類ごとに色の塗りつぶしを変えたい場合は，fillに指定する。
p

p = ggplot2::ggplot() + 
  geom_histogram(data = iris, aes(x=Sepal.Length, color = Species))  #colorだと周りの線の色を変える。
p


```


### 箱ひげ図

`geom_boxplot`で作成する。

最小値，第一分位点，中央値，第三分位点，最大値を示す（外れ値は点で示される）。


```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() + 
  geom_boxplot(data = InsectSprays, aes(x=spray, y=count))
p

p = ggplot2::ggplot() + 
  geom_boxplot(data = InsectSprays, aes(x=spray, y=count, fill = spray))
p

```


### バイオリンプロット

データの分布を表現したグラフ。
`geom_violin`で作成する。

```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() + 
  geom_violin(data = InsectSprays, aes(x=spray, y=count))
p

p = ggplot2::ggplot() + 
  geom_violin(data = InsectSprays, aes(x=spray, y=count, fill = spray))
p

```



### 折れ線グラフ

`geom_line()`を使う。`geom_line()`だけだと線のみだが，`geom_point()`で作ったグラフを重ねることで，点もつけることができる。このように，*複数のグラフを重ねて描画することもできる*。

```{r}

#サンプルデータをつくる: 10日間の気温の変化
temperature = data.frame(
    Days  = 1:10, 
    Celsius = c(17.2, 17.5, 18.1, 18.8, 19.0, 19.2, 19.7, 20.2, 20.5, 20.1)
)
temperature

p = ggplot2::ggplot() + 
  geom_line(data = temperature, aes(x=Days, y=Celsius)) + 
  geom_point(data = temperature, aes(x=Days, y=Celsius)) 
p

```

### エラーバーつきのグラフ

`geom_errorbar()`でエラーバーをつけることができる。
あるいは，`geom_pointrange()`でも作れる。

```{r}

#サンプルデータをつくる
sample_dat = data.frame(Condition=c("A", "B" ,"C"), 
                        mean=c(2, 5, 8), 
                        lower=c(1.1, 4.2, 7.5), 
                        upper=c(3.0, 6.8, 9.1))
#meanが平均，lowerとupperにそれぞれ下限値と上限値。

p = ggplot2::ggplot() + 
  geom_point(data = sample_dat, aes(x = Condition, y = mean)) + 
  geom_errorbar(data = sample_dat, aes(x = Condition, ymax = upper, ymin = lower), width = 0.1) 
#まず，geom_pointで平均を点で示したグラフを作成する。そのグラフに，ymaxとyminにそれぞれ上限値と下限値を指定したエラーバーのグラフを重ねる（widthでエラーバーの横の長さを指定できる）。
p


p2 = ggplot2::ggplot() + 
  geom_pointrange(data = sample_dat, aes(x = Condition, y = mean, ymax = upper, ymin = lower)) 
#geom_pointrangeならば，点とエラーバーの両方を一括して指定できる。
p2

```



## オプション


### ファセット（Facet）

グループごとにグラフを分けたい場合は，ファセット（facet）を利用すると良い。`facet_wrap()`を使う。

```{r, message=FALSE, warning=FALSE}
p = ggplot2::ggplot() +
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) + 
  facet_wrap(vars(Species)) 
p

```

### ラベル（labs）

x軸やy軸のラベルを変えたいときは，`labs`を使うと良い。

```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() +
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) + 
  labs(x = "Length of sepal", y = "Length of petal")

```



### テーマ（Theme）

`theme()`で，フォントの大きさや色などグラフのテーマも細かく変えることができる。具体的にどの部分を変えられるかは，`theme()`のヘルプで確認してほしい。  
  

```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() +
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) 
p + theme(axis.title.x = element_text(size = 20)) #x軸のフォントサイズを変える
p + theme(panel.background = element_rect(fill = "white", colour = "black")) #背景や枠線の色を変える

```

  
手っ取り早く一括でテーマを変えたい場合は，予め用意されている既存のテーマを選ぶと良い。`theme_bw()`, `theme_classic()`などが用意されている。 

```{r, message=FALSE, warning=FALSE}

p = ggplot2::ggplot() +
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) 
p + theme_bw()
p + theme_gray()
p + theme_classic()

```


## 図の保存

`ggplot2`パッケージの`ggsave()`で保存できる。`plot`に保存した図を，`filename`にファイル名を指定すると，ワーキングディレクトリに作成した図が保存される。

```{r, eval=FALSE}

p = ggplot2::ggplot() + 
  geom_point(data = iris, aes(x=Sepal.Length, y=Petal.Length)) + 
  labs(x = "Sepal Length", y = "Petal Length") + 
  theme_bw()

ggplot2::ggsave(plot = p, filename = "plot.png") #ファイル名を指定する。拡張子も忘れずにつける。
ggplot2::ggsave(plot = p, filename = "plot_2.png", dpi = 300) #解像度（dpi）を指定可能。
ggplot2::ggsave(plot = p, filename = "plot_3.png", width = 8, height = 5) #幅(width)や高さ(height)を指定可能（単位はインチ）。

```

Rに標準で入っている関数でも図をファイルで保存することも可能。

```{r, eval=FALSE}

#png形式で保存する場合
png("plot.png")  #描画デバイスを開く（ファイル名を指定する）
plot(iris$Sepal.Length, iris$Petal.Length) #グラフを作る
dev.off()    #描画デバイスを閉じる


```


RStudioならば，plotsウィンドウの「Export」を選んで保存することも可能。

## その他の機能

`ggplot2`の機能はまだまだある。このテキストで説明しきれていないことについては，関数のヘルプやRStudioのサイトにある`ggplot2`のCheat sheetを見てみよう（日本語訳もある）。  
[https://rstudio.com/resources/cheatsheets/](https://rstudio.com/resources/cheatsheets/)

## 確認問題{-}

Rに標準で入っている`mtcars`データを使って，グラフを作成しよう。

### 問１{-}

Rで標準で入っている`hist()`を使って，変数`mpg`のヒストグラムを作ろう。  

### 問２{-}

Rで標準で入っている`plot()`を使って，変数`mpg`と変数`wt`の散布図を作ろう。


### 問３{-}

`ggplot()`で，変数`mpg`と変数`wt`の散布図を作ろう。グラフには以下の点を反映させること。  
  
* x軸をmpg，y軸をwtとする。  
* x軸のラベルは「Miles/gallon」，y軸のラベルは「Weight」とする。  
* テーマはtheme_classic()にする。  

