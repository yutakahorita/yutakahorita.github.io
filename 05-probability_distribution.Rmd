
```{r, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)
library(tidyverse)
```

# 確率分布

確率分布とは何かについて学ぶ。

* 確率変数と確率分布
* 二項分布
* 正規分布と中心極限定理
* その他の確率分布  
  
  
準備として，以下のプログラムを実行する。
  
* tidyverseパッケージのインストールとロード  
* 乱数の種の設定（このテキストに書かれているプログラムと同じ結果が再現できる）。

```{r, echo=TRUE, eval = FALSE, message=FALSE, warning=FALSE}
install.packages("tidyverse")
library(tidyverse)
set.seed(1234)

```


## 確率変数と確率分布


まず，サイコロを例として，確率分布とは何かについて説明する。

サイコロを1個投げるとする。それぞれの目が出る確率は1/6である。それぞれの目をX（1, 2, 3, 4, 5, 6），それぞれの目が出る確率をP(X)とする。  
XとP(X)を以下の表1で示す。  
  

表1    
![](04_table01.png)  
  
このとき，Xを**確率変数**と呼ぶ。確率変数とは，その値と対応する確率が存在する変数のことをいう。表1のように，確率変数とその変数が取り得る確率の分布を**確率分布**という。  
  
確率分布には様々な種類が知られている。

## 一様分布

1個のサイコロをふったときのそれぞれの目が出る確率のように，どの確率変数Xについても常に一定値の確率を取る確率分布は**一様分布(uniform distribution)**と呼ばれる。  
  

## 二項分布

### 二項分布の例

コインをn回投げる。表が出る確率を$q$とすると, 裏が出る確率は$(1-q)$となる。n回中，表がx回出る確率P(x)は，理論的には以下の式で算出される。

$$
P(x) = {}_n\mathrm{C}_xq^{x}(1-q)^{(n-x)}
$$

xを確率変数とした場合，上記の式の確率に従う確率分布を**二項分布**という。
つまり二項分布は，**2つのカテゴリで表現されるある事象が，何回生じるか**の確率を表している。コイン（表か裏）を何回か投げたときの表が出る回数，学生（男か女）の中から選んだときの男の人数など。このような事象が生じる確率は，理論的には二項分布に従う。  
  

コインを投げる場合の例に戻る。例えば，表が出る確率`q`を`0.5`として，10回投げたときに表が6回出る確率を計算してみよう。Rならば，`dbinom()`関数を使えば計算できる（この関数の意味については，また後で説明する）。

```{r}

#xは確率変数（コインの例でいうと表が出た回数），sizeは試行回数（コインの例でいうとコインを投げた回数），
dbinom(x=6, size=10, prob=0.5)

#上の式n, x, pに実際に値を入れて計算する場合。dbinom()関数を使った場合と結果が一致することを確認しよう。
choose(10, 6) * 0.5^6 * (1 - 0.5) ^4

```

### 二項分布の期待値と分散

表が出る回数xが0〜10回の場合全てについて，それぞれが生じる確率を計算すると以下のようになる。

```{r}

dbinom(x=0:10, size=10, prob=0.5)

```

グラフにすると以下のようになる。横軸をx, 縦軸をP(x)とする。

```{r, echo=FALSE}

d_plot = data.frame(x=0:10, p=dbinom(x=0:10, size=10, prob=0.5))

p = ggplot() + 
  geom_bar(data = d_plot, aes(x = factor(x), y = p), stat="identity") + 
  labs(y= "P(x)", x= "x")
p
```

グラフからもわかるように，表が出る確率が0.5のコインを10回投げたときに，最も出やすいのは10回中5回であることがわかる。10回中1回，10回中10回出るケースはほとんどまれであることがわかる。  
この図からも，確率分布には最も出やすい変数（平均値。確率分布の場合は期待値と呼ぶ）と分散が存在することがわかる。  
  
二項分布の期待値$E(x)$と分散$Var(x)$は，以下の式から計算できる。

$$
E(x) = nq\\
Var(x) = nq(1-q)
$$

表が出る確率が0.5（i.e., q=0.5）のコインを10回(i.e., n=10)投げた場合における，表が出る回数xの期待値と分散を計算してみよう。

```{r}

#E(x) = nq
10*0.5

#Var(x) = nq(1-q)
10*0.5*(1-0.5)

```

### ベルヌーイ分布

二項分布でn=1のときは，*ベルヌーイ分布*と呼ばれる。  
  
例： 
コインを一回だけ投げたときに，表が出る，あるいは裏が出る確率。


```{r}

dbinom(x=0:1, size=1, prob=0.5)
dbinom(x=0:1, size=1, prob=0.4)

```



## 正規分布

### 正規分布の基礎

統計学で用いられる確率分布の中でも有名なのは*正規分布*である。正規分布は，平均$\mu$，標準偏差$\sigma$をパラメータとする確率分布で，釣鐘型（ベル・カーブ）状の分布を描く。  
  
平均$\mu$，標準偏差$\sigma$とする正規分布の確率密度関数f(x)は，以下の式から計算される。  
  

$$
f(x) = \frac{1}{\sqrt{2\pi\sigma^2}}\exp\left(-\frac{(x-\mu)^2}{2\sigma^2}\right)
$$

* この式自体を覚える必要はない。  
  
* これは正確には確率分布ではなく，**確率密度関数**と呼ばれるものである。先程の二項分布では，縦軸は横軸の値が生じる確率を意味していた。しかし，正規分布のグラフ（確率密度関数）の縦軸は，横軸の生じる確率そのものを意味しない。グラフの面積が確率を意味する。グラフの面積全てを合計した値は1となる。  
  
試しに，平均0，標準偏差1の正規分布のグラフを作ってみよう。

```{r, eval=FALSE}
x = seq(-3, 3, 0.05) # -3から3まで0.05刻みで数字の連続を作る
y = dnorm(x=x, mean=0, sd=1) #平均0，標準偏差1の正規分布の確率を算出する
dat_norm = data.frame(x = x, y = y)

p = ggplot() + 
  geom_line(data = dat_norm, aes(x = x, y = y))
p

```

0 ≤ x ≤ 1の確率は，その範囲に対応するグラフの面積となる。

```{r}

#Rならば，pnorm関数でxが-∞からqまでの範囲の確率を求めることができる
#以下は，平均0，標準偏差1の正規分布で 0までの確率を求めている。正規分布の半分に相当するので，0.5である。
pnorm(q = 0, mean = 0, sd = 1)

#特定の範囲を求めたい場合は以下のように使えば良い。例えば以下は，xが1から2の範囲の確率である。
pnorm(q = 1, mean = 0, sd = 1) - pnorm(q = 0, mean = 0, sd = 1) 


```

以下が平均$\mu$と標準偏差$\sigma$の値をそれぞれ変えた場合の正規分布である。赤が平均0で標準偏差1，青が平均1で標準偏差1, 黒が平均0で標準偏差2である。


```{r, echo=FALSE}

x = seq(-3, 3, 0.05)

y_1 = dnorm(x=x, mean=0, sd=1) 
y_2 = dnorm(x=x, mean=1, sd=1) 
y_3 = dnorm(x=x, mean=0, sd=2) 


dat_norm_1 = data.frame(x = x, y = y_1)
dat_norm_2 = data.frame(x = x, y = y_2)
dat_norm_3 = data.frame(x = x, y = y_3)

p = ggplot() + 
  geom_line(data = dat_norm_1, aes(x = x, y = y), color="red")+
  geom_line(data = dat_norm_2, aes(x = x, y = y), color= "blue")+
  geom_line(data = dat_norm_3, aes(x = x, y = y), color="black")
p



```


### Rで使える確率分布の関数

ここまで，dbinom，dnorm, pnormなどの関数が出てきた。これらは，Rに標準で入っている確率分布に関する関数である。  
  
Rには確率分布から乱数を生成したり，確率変数の確率を求めることができる関数が実装されている。関数は，確率分布につきrXXXX, qXXXX, pXXXX, dXXXXの機能が異なる4種類の関数が用意されている（
XXXXは確率分布を意味する）。  
  

```{r}

#rXXXXは，乱数(random number)を出力する。
rnorm(n = 10, mean = 0, sd = 1) #平均0，標準偏差1に従う正規分布から乱数を10個生成する

#dXXXXは，確率変数xが生じる確率密度を出力する。
dnorm(x = 0.5, mean = 0, sd = 1)  # 平均0，標準偏差1に従う正規分布 で，x=0.5のときの確率密度を求める（確率密度の値であって，確率ではないので注意）

#qXXXXは，確率点(quantile)を出力する。
qnorm(p = 0.5, mean = 0, sd = 1)  # 平均0，標準偏差1に従う正規分布 で，p ≤ 0.5の確率となるときの確率変数のお値を求める


#pXXXXは，累積確率を出力する。
pnorm(q = 1, mean = 0, sd = 1)  # 平均0，標準偏差1に従う正規分布 で，x ≤ 1の確率を求める


```


### なぜ正規分布はよく使われるのか？

現実世界の様々なデータが正規分布に従うから？  
→実際には正規分布に従わないデータの方が多い。  

* 体重や身長なども，実際には正規分布を描くことは少ない。年収なども釣鐘型の分布にならない  
* 正規分布は確率変数が連続量の場合の確率分布である。テストの点数や質問紙の回答得点など，離散値や順序尺度（すなわちカテゴリカル変数）が正規分布に従うというのはそもそも前提が異なっている。  
 
では，正規分布がよく使われる理由は何なのか。もっとらしい理由は，数学的な扱いやすさである。なぜならば，元の変数がどのような確率分布に従っていたとしても，変数を足し合わせた結果は正規分布に従うという都合の良い性質があるからである。


### 中心極限定理


**中心極限定理**とは，「母集団が平均及び標準偏差を持つ確率分布ならば，たとえ母集団が正規分布でなくても，母集団から標本を無作為抽出して平均値を計算することを何回も繰り返すとその分布は正規分布に近づく」という定理である。  
  
    
シミュレーションで中心極限定理を実感してみよう。6面のサイコロを100回振る実験を行うとする。

```{r}
X = round(runif(n = 100, min = 1, max = 6),0) #round()は値を丸める関数。ここでは小数点以下の値を0として整数の値を出力するようにしている
mean(X)
```

それぞれの目が出る確率は1/6で一定である。すなわち，サイコロが出る目は一様分布に従う（つまり，元の分布は正規分布ではない）。一様分布の平均値は，最大値をa, 最小値をbとすると，(a+b)/2。すなわち，サイコロの例の場合の平均値は理論的には(1+6)/2=3.5となる。  
    
サイコロを100回振って平均値を求める。この平均値を求めるのを，1,000回繰り返し行う。求めた平均値1,000個の分布を見てみると，  
  
（以下のプログラムを実行すると，グラフを描ける。プログラムの意味の説明は省略する）

```{r, message=FALSE, warning=FALSE}
sample.means = sapply(c(1:1000), function(x) {mean(round(runif(n = 100,min=1,max=6),0))} )

qplot(sample.means)
```


正規分布に近似する。1,000回よりももっと回数を増やすと，より正規分布っぽいかたちになる。  

このように，元の母集団の分布がたとえ正規分布でなくても，その標本平均は正規分布に近似する。  
  
  
平均を計算しなくても，単に値を足し合わせるだけでも同じことである。  

```{r, message=FALSE, warning=FALSE}
#サイコロを7回振ってその合計を求める。これを10,000回行ったときの出目の合計値の分布
Y = round(runif(n = 10000,min=1,max=6),0) + 
  round(runif(n = 10000,min=1,max=6),0) + 
  round(runif(n = 10000,min=1,max=6),0) +
  round(runif(n = 10000,min=1,max=6),0) +
  round(runif(n = 10000,min=1,max=6),0) +
  round(runif(n = 10000,min=1,max=6),0) +
  round(runif(n = 10000,min=1,max=6),0)
qplot(Y)


```


中心極限定理が成り立つため，たとえ元の変数が正規分布に従ってなくても，合成したものは正規分布に近似する。なので，心理学で行われる様々なデータ分析も，以下のような処理を行うことで変数が正規分布に従うという前提を置いてもおおきな問題はない。
  
* 複数の質問項目（順序尺度）をまとめて平均化した心理尺度を分析に使う。  
* 選挙への投票（「した」もしくは「しなかった」の二値）者の割合を県ごとに算出して，県を単位として分析に使う。  


中心極限定理は簡単に言うと，「どのような確率分布に従う変数でも，足し合わせると正規分布になる」である。  
※ただし，例外はある（後述）


## ポイント

確率分布には，その形状を決定づける**パラメータ**が存在する。  
  
例えば，二項分布のパラメータは確率pと回数nである。正規分布は，平均$\mu$と標準偏差$\sigma$である。   
  
元がたとえ正規分布でなくても，**足し合わせたものは正規分布に近似する**。ゆえに，正規分布は様々な統計分析に適用できる「正規な（normal）」分布なのである。

#### 確率分布の表現の仕方

今後，確率変数と確率分布の関係を以下の式で表現することにする。


##### 二項分布の場合

$$
x \sim Binomial(n, q)
$$

Binomialのカッコ内のn, qのように，確率分布を構成する変数のことをパラメータと呼ぶ。
Binomialは二項分布，$\sim$は「従う」という意味である。つまりこの式は，「xは，nとqをパラメータとする二項分布に従う」ということをいっている。


##### 正規分布の場合


$$
x \sim Normal(\mu, \sigma)
$$


正規分布のパラメータは，平均と標準偏差である。この2つが決まれば，正規分布の形状も決まる。


## その他の確率分布（＊）


他にも，よく使う確率分布を以下に示す。


### ポアソン分布{-}

$$
P(x) = \frac{\lambda^x\exp(-\lambda)}{x!}\\
x \sim Poisson(\lambda)\\
$$

* xは0以上の整数（0, 1, 2, 3, ...）とする。  
* ポアソン分布のパラメータは$\lambda$だけである。期待値（平均）は$\lambda$，分散は$\lambda$である。つまり，平均と分散が等しい分布である。
* 以下に，パラメータ$\lambda$をそれぞれ変えた場合のポアソン分布を示す。

```{r, echo=FALSE}
pois_1 <- data.frame(x=seq(0,10), p=dpois(seq(0,10), lambda=1), lambda=1)
pois_2 <- data.frame(x=seq(0,10), p=dpois(seq(0,10), lambda=2), lambda=2)
pois_3 <- data.frame(x=seq(0,10), p=dpois(seq(0,10), lambda=3), lambda=3)
pois <- rbind(pois_1, pois_2, pois_3)
ggplot(data=pois, aes(x=factor(x), y=p, fill=factor(lambda))) + geom_bar(stat="identity", position = "dodge") + ylab("P(x)") + xlab("x") + labs(fill = "lambda")
```

* 一定の期間中にランダムで生じる事象はポアソン分布に従う。具体的な例としては，1日の間に届くメールの件数，営業時間中に来る客の数など。

* 二項分布$Binomial(n, p)$の$n$が十分大きく，かつ$p$が小さい場合は平均を$np$とするポアソン分布に近似する。つまり，めったに起こらない事象はポアソン分布に従う。例えば，1年間の間に生じる交通事故の件数など（365日それぞれで0.1%で生じるとした場合）。歴史的に有名な例は，「ドイツ軍で1年間で馬に蹴られて死亡した兵士の数」がポアソン分布に従うというもの。

### 指数分布


### 対数正規分布



## 練習問題{-}


### 問１{-}

* あなたは野球部の監督で，自分のチームの勝率はこれまでの練習の経験から32%だとわかっている。
* これから遠征で，全部で10試合を行う予定である。

* 勝つ試合の回数を確率変数nとし，nとそれぞれのnに対応する確率を表で示せ。
* 平均して何試合勝つことができるかを述べよ。



### 問２{-}

* ある学校で小学6年生の身長を測ったところ，平均は150.2 cmで標準偏差が3.5 cmであった。

* 身長152 cmから155 cmの児童の割合はいくらか。
* 身長158 cmを超える児童は何割いるか。
    + ヒント：pnorm関数を使おう。なお，全ての範囲の確率の合計は1である。


## 補足

### 確率分布に関連するRの関数

Rには，確率分布から乱数や確率を求めるための関数が用意されている。例えば，以下が正規分布(normal distribution)に関する関数である。

```{r, eval=FALSE}

rnorm(n=100, mean=0, sd=1) #random: 乱数
dnorm(x=-1:1,mean=0, sd=1) #density: 確率密度
pnorm(q=0.1, mean=0, sd=1) #probability: 累積分布
qnorm(p=0.5398278,mean=0, sd=1) #quantile:確率点

```


他の確率分布に関する関数も用意されている。

```{r, eval=FALSE}

#乱数を作る関数
runif(n=100, min = 0, max = 1) #一様分布からの乱数
rbinom(n=100, size=10, prob=0.5) #二項分布からの乱数
rpois(n=100, lambda = 3) #ポアソン分布からの乱数
rexp(n=100, rate = 1) #指数関数


```


### 中心極限定理の例外

中心極限定理より，元がどのような分布でも足し合わせると正規分布に近似すると述べたが，例外もある。例えば，**コーシー分布（Cauchy distribution）**と呼ばれる確率分布は，中心極限定理を適用できない。  
  
コーシー分布は形状が正規分布に似ているが，裾が広いことが特徴である。つまり，極端な値が出る確率が正規分布よりも大きい。  
  
パラメータは，locationとscaleの2つである。以下に，locationが0，scaleパラメータが1と3の分布の例を示す。

```{r, include=FALSE}

dat_cauchy_1 = data.frame(x = seq(-6, 6, 0.01), 
                        y= dcauchy(x = seq(-6, 6, 0.01), location = 0, scale = 1), 
                        scale = "1")

dat_cauchy2 = data.frame(x = seq(-6, 6, 0.01), 
                        y= dcauchy(x = seq(-6, 6, 0.01), location = 0, scale = 3), 
                        scale = "3")

dat_cauchy = rbind(dat_cauchy_1, dat_cauchy2)

ggplot() + 
  geom_line(data = dat_cauchy, aes(x = x, y = y, linetype = scale)) + xlim(-6,6) + labs(x = "y", y = "density") + theme_classic()


```

コーシー分布は，極端な値が存在することにより，その分布の特徴を平均や標準偏差などで捉えることができない。

```{r}

d_cauchy = rcauchy(n = 100, location = 0, scale = 1) #location = 0, scale = 1のコーシー分布から乱数を100個生成する

mean(d_cauchy)
median(d_cauchy)
sd(d_cauchy)

```



コーシー分布から乱数を100個作って足し合わせることを5回やり，分布を確認する。足し合わせても，正規分布に近似しない。

```{r}

d_cauchy = rcauchy(n = 100, location = 0, scale = 1) + 
rcauchy(n = 100, location = 0, scale = 1) + 
rcauchy(n = 100, location = 0, scale = 1) + 
rcauchy(n = 100, location = 0, scale = 1) + 
rcauchy(n = 100, location = 0, scale = 1) 

hist(d_cauchy)

```



