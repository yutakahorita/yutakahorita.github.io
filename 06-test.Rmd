
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
set.seed(1234)
```

# ｔ検定，分散分析

これまで学んできた様々な統計的検定について復習をする。  
* t検定  
* 分散分析  
  
理論については深く掘り下げない（統計学の基礎授業で学んでいるので）。どの分析も前回学んだ「データが帰無仮説の分布に従うとしたときに，今回得られたデータが得られる確率がどれくらいまれか」を検討している点で共通している。様々な統計的検定の復習を通して，帰無仮説検定の考え方（p値とは何か）について理解する。  
  
  
必要なパッケージのインストールと乱数の種の指定をする。

```{r, eval=FALSE}
installed.packages("tidyverse")
library(tidyverse)

set.seed(1234)

```

## t検定

連続量の変数を扱う検定の場合，t検定を使うのが一般的である。

### 一標本のt検定

まずサンプルデータとして，平均0, 標準偏差1の正規分布からランダムに10個サンプルしたデータXを作る。  
それぞれの平均と標準偏差を求めてみる。

```{r}
set.seed(1234)
X = rnorm(n = 10, mean = 0, sd = 1)
X

mean(X)
sd(X)
```

このデータ`X`から，帰無仮説「母集団の平均$\mu = 0$」を検定する。


```{r}
#mu=0は入力しないでもOK
t.test(X, mu=0)

```

t値，自由度(df)，p値が出力される。  
t値は以下の式から計算された統計量である。

$$
t = \frac{\bar{X} - \mu}{\sqrt{s^2/n}}
$$

Xが$N(\mu, \sigma^2)$に従う場合，tは自由度$n-1$のt分布に従う。

式にサンプルデータの平均と分散を入れてt値が`t.test()`で求めたものと一致するかを確かめてみよう。

```{r}
t = (mean(X) - 0) / sqrt(var(X)/10)
t
```


Rならば，`t.test()`を使えばt値とp値，更に母集団の平均$\mu$の95%信頼区間を出力してくれる。  
出力結果から，$N(\mu, \sigma^2)$から今回観測されたデータX以上のtが得られる確率は`r round(pt(t, 10 - 1)*2, 2)`であるということを示している。この確率はまれといえるか（5%未満か）について結論を下す。


### 二標本の差のt検定（対応なし）

```{r}
set.seed(1234)
Value = c(rnorm(n = 10, mean = 0, sd = 1), rnorm(n = 10, mean = 1, sd = 1))
Treatment = c(rep("X", 10), rep("Y", 10))
sample_data = data.frame(Treatment = Treatment, Value = Value)


sample_data %>% group_by(Treatment) %>%
  summarise(Mean = mean(Value), SD = sd(Value), N = length(Value))

```


Xのサンプル数をm,  Yのサンプル数をnとする。

$$
t = \frac{\bar{X} - \bar{Y}}{\sqrt{s^2_{X}/m+s^2_{Y}/n))}}
$$
XとYは同じ$N(\mu, \sigma^2)$に従う時，t値は自由度$m+n-2$のt分布に従う。  
つまり，同じ母集団からXとYが抽出されたと仮定した時（$\bar{X} - \bar{Y}$），今回のデータが得られる確率がどのくらいまれであるかを検討する。


```{r}

#2つの標本の母分散が等しいと仮定できない場合
#ウェルチの検定(Welch's t-test)と呼ばれる検定
t.test(data = sample_data, Value ~ Treatment, paired = F)

#2つの標本の母分散が等しいと仮定する場合
#var.equal = Tを指定する（デフォルトでvar.equal = Fとなる）
t.test(data = sample_data, Value ~ Treatment, paired = F, var.equal = T)

```


等分散を仮定した場合しない場合いずれも，それぞれの平均の間に有意な差があるといえる。

* 論文などにt検定の結果を報告するときは一般的に，「t(17.9)=2.74, p = 0.01」と書く。つまり，t値，自由度，p値を報告する。
* 一般的に2つの標本の母分散は不明であるので，それらが等しいかどうかも不明である。なので，等分散を仮定しないt検定をしておくほうが保守的である。

### 二標本の差のt検定（対応あり）

```{r}
t.test(data = sample_data, Value ~ Treatment, paired = T)

#なお，等分散を仮定する場合はvar.equal = Tを指定する。
t.test(data = sample_data, Value ~ Treatment, paired = T, var.equal = T)

```


## 分散分析

t検定で比較できるのは2群までである。3群以上の間で平均値の比較を行いたい場合は，分散分析（ANOVA）を行う。


### 一要因の分散分析

```{r}

#サンプルデータ
Y1 = c(1, 2, 3)
Y2 = c(5, 7, 5)
Y3 = c(5, 4, 2)
Value = c(Y1, Y2, Y3)
Treatment = factor(c(1, 1, 1, 2, 2, 2, 3, 3, 3))
sample_data2 = data.frame(Treatment = Treatment, Value = Value)
sample_data2

```

それぞれ3つのグループ（X = 1, 2, or 3）で変数Yを取ったとする。
グループごとの平均値などは，以下のようになっている。これら3つのグループの間で平均値に差があるのかを検定する。

```{r}

sample_data2 %>% dplyr::group_by(Treatment) %>% 
  dplyr::summarise(Mean = mean(Value), SD = sd(Value), N = length(Value))

```



```{r}

result_anova = aov(data = sample_data2, Value ~ Treatment)
summary(result_anova)

#以下でも同じ結果が出る
oneway.test(data = sample_data2, Value ~ Treatment, var.equal = TRUE)


```

```{r}

#lm関数でも分散分析表を出せる（ただし，lm関数を使った場合ではTukeyHSD()は使えないので注意。多重比較をしたい場合はaov()を使う。
result_anova_2 = lm(data = sample_data2, Value~Treatment)
anova(result_anova_2)

```


* ここでは分散分析の理論の詳細は省略する。 簡単に説明すると，分散分析ではグループ間の分散がグループ内の分散と比べて大きい確率を求めて，群の間で平均値に差があるかを検定する。 

* 回帰分析（正確には線形モデルと呼ばれる統計解析の枠組み）でも，分散分析と同様の目的の検定を行うことができる。  
* 分散分析は要因の数やそれぞれの要因の対応ありなしによって，やり方が複雑になる（例えばテストの成績に対して，男女，学年，科目によってどう差があるかを検討するなど）。線形モデルならば，もっとシンプルに行うことができる。  
* 分散分析の結果を論文で報告するときは，「F(2, 6) = 2.26, p = .19」といったように報告する。  


* `anova()`では，逐次平方和（Type Ⅰ SS）が出力される（要因の各セルのデータ数にかたよりがある場合，独立変数を投入した順序（x1, x2とx2, x1）で平方和の値の計算結果が異なる場合がある）。調整平方和（Type Ⅱ，Type Ⅲ）を出したいときは，`car`パッケージの`Anova()`など別のパッケージが必要になる。  



### 多重比較

「3つのグループの間で平均値に差がない」という帰無仮説が棄却された場合，どのグループの間に有意な差があるのかを検定する必要がある。このサンプルデータの場合，グループ１とグループ２，グループ２とグループ３，グループ１とグループ３との間，計３つの組み合わせで平均値の比較を行う。つまり，t検定を3回行って条件間の比較をする。  
    
ただし，第5回でも述べたように，統計的検定を繰り返し行う（多重比較）と第一種のエラーを犯す確率が増える。t検定で出てきたp値をそのまま報告するのではなく，多重比較の問題を考慮した上でp値に補正をかける（p値を過大に評価し直す）必要がある。  
  
多重比較の補正法には，いくつかの方法がある。
* ボンフェローニ（Bonferroni）の方法: p値を比較の回数分かけて過大に評価する  
* チューキー(Tukey)の方法  
* ホルム(Holm)の方法  


多重比較の補正を行うときは，pairwise.t.test関数を使う。各群間の比較について，補正後のp値が出力される。

```{r}

pairwise.t.test(sample_data2$Value, g = sample_data2$Treatment, p.adjust.method = "bonferroni") #gがグループを意味する変数，p.adjust.methodに補正方法を指定する。

pairwise.t.test(sample_data2$Value, g = sample_data2$Treatment) #オプションに何も指定しないと，ホルムの方法の結果が出力される。ボンフェローニの方法は保守的すぎるので，他の方法の方が好まれる。

```


```{r, eval=FALSE, include=FALSE}

#pairwise.t.testでは２群をプールした標準偏差が用いられている。プールした標準偏差を用いないt検定にすると，２群間のt検定の結果と一致する。
pairwise.t.test(sample_data2$Value, g = sample_data2$Treatment, p.adjust.method = "bonferroni", pool.sd = F)  

#条件１と条件２の間で比較
data <- sample_data2 %>% filter(Treatment !=3)
t.test(data=data, Value~Treatment, paired=F)$p.value * 3

```

よく使われるチューキーの方法を使う場合は，`TukeyHSD()`が用意されている。

```{r}

TukeyHSD(result_anova) #TukeyHSD()に，分散分析表の結果を入れる

```


## まとめ

* 統計学の基礎の復習として，これまで学んだ統計解析（＋α）の復習をしてきた。いずれも考え方は共通していて，「データから求めた統計量が帰無仮説に従うとしたときに，今回のデータよりもまれな事象が得られる確率（p値）」を求めている。  
* 更に，これまで学んできた統計手法は統計モデルというかたちで包括的に理解することができる。詳しくはまた後日学ぶ「一般化線形モデル」の回で扱う。t検定，分散分析なども，「一般化線形モデル」の中に含まれる。「一般化線形モデル」を理解すれば，様々なデータに対して適切な分析を行うことができるようになる。  
* 次回はp値を基準として結論を出す帰無仮説検定が抱える問題について扱う。  


## 練習問題{-}


### 問１{-}

以下のプログラムを読み込む。  
  
あるサプリメントにダイエットの効果があるかを検討するために，10名を対象に実験を行った。それぞれの参加者にサプリメントを投与する前(before)と投与した後（after）で体重を測定した（架空のデータである）。


```{r}


before = c(37.93, 52.77, 60.84, 26.54, 54.29, 55.06, 44.25, 44.53, 44.36, 41.1)
after = c(57.84, 50.02, 53.36, 65.97, 79.39, 63.35, 57.33, 51.33, 52.44, 101.24)
Value = c(before, after)
Treatment = c(rep("before", 10), rep("after", 10))
Subject = c(c(1:10), c(1:10))
sample_1 = data.frame(Subject = Subject, Treatment = Treatment, Value = Value)
sample_1


```

* 投与前と投与後それぞれについて，体重の平均値及び標準偏差を求めて報告せよ。  
* このサプリメントの投与により体重が変化したかについてt検定（等分散を仮定しない）で検討し，結果について報告するとともに結論を述べよ。


### 問２{-}

以下のプログラムを読み込む。  
  
ある教授法に児童の学力向上の効果があるかを検討した。学校Bにはその教授法を実施し，学校Aには何もしなかった。その後，学校Aと学校Bそれぞれ10人の生徒に学力テストを行った。A，Bそれぞれが学校A，Bそれぞれの生徒の成績である（架空のデータである）。


```{r}

A = c(38, 53, 61, 27, 54, 55, 44, 45, 44, 41)
B = c(48, 40, 43, 56, 69, 53, 47, 41, 42, 91)
Value = c(A, B)
Treatment = c(rep("A", 10), rep("B", 10))
sample_2 = data.frame(Treatment = Treatment, Value = Value)
sample_2

```

* 学校Aと学校Bそれぞれについて，テストの得点の平均値及び標準偏差を求めて報告せよ。  
* この教授法に成績向上があったかどうかについてt検定（等分散を仮定しない）で検討し，結果について報告するとともに結論を述べよ。


### 問３{-}

以下のプログラムを読み込む。  
    
A県, B県, C県のそれぞれで学力テストを行った。各県で10名の生徒の成績を集計し，県(prefecture)ごとの得点（score）である（架空のデータである）。A，Bそれぞれが学校A，Bそれぞれの生徒の成績である。


```{r}

Value = c(38, 40, 58, 27, 54, 55, 44, 45, 44, 41, 44, 38, 41, 51, 62, 49, 44, 39, 40, 79, 61, 55, 56, 65, 53, 46, 66, 50, 60, 51)
Prefecture = c(rep("A", 10), rep("B", 10), rep("C", 10))
sample_3 = data.frame(Prefecture = Prefecture, Value = Value)
sample_3

```


A県，B県，C県の成績の平均値及び標準偏差は以下の通りである。

```{r, echo=FALSE}

table <- sample_3 %>% dplyr::group_by(Prefecture) %>% 
  dplyr::summarise(Mean = mean(Value), SD = sd(Value), N = length(Value))

kable(table)
```


* 県によって学力に違いがあるかについて一元配置分散分析で検討し，結果について報告するとともに結論を述べよ。

* 県の間で学力に有意差が見られた場合は，どの県とどの県との間に有意差があるかをホルムの方法で確認し，結果について報告せよ。


