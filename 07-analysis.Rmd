

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
set.seed(1234)
```



# 様々な解析法

この章では，t検定，χ二乗検定，分散分析，ノンパラメトリック検定など，心理学における基礎統計学で学んできた手法について，Rでの解析法をみながら内容についておさらいしていく。  
  
データ分析をするときは，「データが量的変数で2つのグループ間での比較ならばt検定」，「データが量的変数で3つ以上のグループ間での比較ならば分散分析」といったように，更には「変数が正規分布に従わないときにはノンパラメトリック検定」といったように，様々な条件に応じて解析方法を使い分けてきたように思う。  
  
このテキストでは，t検定や分散分析などの手法を，「統計モデル」という一つの枠組みで捉えることが目的である。  
  
まず，準備として`tidyverse`パッケージをロードしよう。

```{r, eval=FALSE}
library(tidyverse)
```


## t検定

「分析の対象が量的変数で，２つのグループの間でその変数の平均値を比較する」ときにはt検定を使うと学んだと思う。更に，t検定には2つのグループに対応があるかないかで，「対応のあるt検定」と「対応のないt検定」で区別される。
  
前の章でもみてきたように，Rにはt検定を行うための`t.test()`関数が用意されている。


### 対応のないt検定

Rに標準で入っている`sleep`データを使って，Rでt検定をやってみよう。

以下のプログラムを読み込み，サンプルデータを作る。

```{r}

ttest_sample = sleep #ttest_sampleという名前保存する。
ttest_sample$ID = 1:nrow(ttest_sample)
ttest_sample

```

IDは参加者を意味する番号で，1から20までの人がグループ1かグループ2のどれかに属し，変数`extra`を測定したとする。グループの間で`extra`に違いがあるかどうかを検討したい。

このように参加者が２つのグループのうちどれか一つに属しているケースが「対応のない場合」で，この場合は対応のないt検定で検討する。  
  
前の章で見たように，`t.test()`関数で以下のように入力すれば結果が出力される。

```{r}

t.test(data = ttest_sample, extra~group)

```


### 対応のあるt検定

同じく，`sleep`データを使って対応のある場合について解析をしてみる。

以下のプログラムを読み込み，サンプルデータを作る。

```{r}

ttest_sample2 = sleep #ttest_sampleという名前保存する。
ttest_sample2

```

今度は20名の参加者が，グループ1とグループ2の両方に属して，それぞれで変数`extra`を測定したとする。

このように同じ参加者が２つのグループのr兵法に属しているケースが「対応のある場合」である。  
  
`t.test()`関数でオプション`paired = TRUE`を入れれば，対応のあるt検定を実施できる。

```{r}

t.test(data = ttest_sample2, extra~group, paired = TRUE)

```


## 分散分析

t検定で比較できるのは2つのグループの間の平均値である。3グループ以上の間で平均値の比較を行いたい場合は，分散分析（ANOVA）を行う。  
  
ここでは，一要因３水準の分散分析（単純に3つのグループの間で平均値を比較する）を例として，Rでの解析法について説明する。  
  
Rでは，一要因の分散分析をするための関数`aov()`が標準で入っている。同じくRで標準で入っている`PlantGrowth`データを使って解析をしてみよう。

```{r}

anova_sample = PlantGrowth #PlantGrowthをanova_sampleという名前で保存する
anova_sample

```

植物の生長を3つの条件で調べたデータである。

まず，３つのグループごとに平均値や標準を確認しよう。

```{r}

anova_sample %>% dplyr::group_by(group) %>% 
  dplyr::summarise(Mean = mean(weight), SD = sd(weight), N = length(weight))

```

`ctrl`，`trt1`，`trt2`の間で平均値に下がるかを一要因の分散分析で検討する。以下のようにプログラムを書く。

```{r ANOVA_1}

result = aov(data = anova_sample, weight ~ group)
summary(result)

```

`summary()`を使うと分散分析表が出力され，変数の効果が有意か否かを検討できる。

一要因の分散分析では「グループの間で平均値に差がない」という帰無仮説を検討する。この例の分析についてはp値は`r round(oneway.test(data = anova_sample, weight ~ group)$p.value, 2)`であり，5%水準で帰無仮説は棄却されることとなる。これは「グループの間で平均値に差がない」という可能性は棄却されたが，どのグループの間に有意な差があるかはわからない。そこで，グループ１とグループ２，グループ２とグループ３，グループ１とグループ３との間，計３つの組み合わせで平均値の比較を行う。つまり，t検定を3回行って条件間の比較をする。  
  
前の章でも触れたように，検定を繰り返すことは第１種の過誤を犯す確率を高めてしまう。そこで，検定を行う回数に応じてp値を厳し目に見積もるペナルティを課すことで，第１種の過誤を犯す確率を低くする工夫がなされる。この工夫が，「**多重比較補正**」と呼ばれるものである。

多重比較の補正を行うときは，pairwise.t.test関数を使う。各群間の比較について，補正後のp値が出力される。  
  
Rでは，多重比較補正を行うための関数として，`pairwise.t.test()`がある。

```{r}

pairwise.t.test(anova_sample$weight, g = anova_sample$group) #gにグループを意味する変数，p.adjust.methodに補正方法を指定する。

```

グループの組み合わせごとに，補正後のp値が表示される。これを見ると，`trt1`と`trt2`との間で5%水準で有意な差があることがわかる。


***
分散分析は選択肢も多く，非常に複雑な解析方法である。上に述べたように，条件が複数ある場合は要因の効果が有意だったら，多重比較補正をして条件間で差の検定がなされる。多重比較補正にもボンフェローニ（Bonferroni)，チューキー(Tukey)，ホルム(Holm)の方法と，様々な方法が提案されている。  
二要因の分散分析，三要因の分散分析，更には二要因対応あり一要因対応なしの分散分析と，要因の数やそれぞれの要因の対応ありなしで分散分析のやり方も非常に複雑になる！  
更には，平方和の値の計算方法もタイプ1, タイプ2，タイプ3と様々な選択肢がある。  
  
このように複雑な分散分析であるが，統計モデルという考え方を導入すれば，簡単に解析のデザインを組みやすくなる。詳しくは次章以降でみていく。

## ノンパラメトリック検定

以上のt検定や分散分析は，分析の対象の変数が「正規分布に従う」を前提とする解析手法である。変数が正規分布に従わない変数，例えば質的変数（人数の比率，順次尺度など）の場合には，t検定や分散分析を用いるのは適切でなく，「**ノンパラメトリック検定**」を使うべきだと指摘されている。  
  
ノンパラメトリック検定とは「変数が正規分布に従うという前提を置かない解析手法」の総称であり，様々な種類が提案されている。  
  
以下では，ウィルコクソンの順位和検定，クラスカル・ウォリスの検定，カイ二乗検定について触れる。

### ウィルコクソンの順位和検定

2群間で値を比較するノンパラメトリック検定である。データを順位データに変換し，2群間でデータの大きさを比較する検定である。  
「マン・ホイットニーのU検定」という名前でも知られる。  
Rでは`wilcox.test()`が用意されている。

```{r, message = FALSE, warning=FALSE}

wilcox_sample = airquality %>% filter(Month >= 8) #Rに入っているサンプルデータairqualityから2群だけ取り出したデータで試してみる
wilcox.test(data = wilcox_sample, Ozone ~ Month)

```

### クラスカル・ウォリスの検定

3群以上で値を比較するノンパラメトリック検定である。同じく，データを順位データに変換して比較を行う。  
Rでは`kruskal.test()`が用意されている。

```{r}

kruskal_sample = airquality #Rに入っているサンプルデータairqualityで試してみる
kruskal.test(data = kruskal_sample, Ozone ~ Month)

```

### カイ二乗検定

解析の対象の変数が質的変数で，頻度に偏りがあるかを比較したい場合は，カイ二乗検定が使われる。  
  
Rには，カイ二乗検定を行うための`chisq.test()`がある。

```{r}

tab = matrix(c(12, 30, 25, 16), ncol=2) #表を作成する

chisq.test(tab) #chisq.testの中に表を入れる

```

カイ二乗検定は比率に偏りがあるかを検定してくれるが，どこに偏りがあるかは研究者自身が表を見て判断するしかない。  
  
## まとめ

心理統計学で学んできた解析をRで行う方法について解説してきた。
これまで，心理統計学では「変数が連続型でグループが２つならばt検定」，「変数が連続型でグループが3つ以上ならば分散分析」，「変数がカテゴリカル変数ならばカイ二乗検定」と変数のタイプや研究デザインに応じて行う解析を選ぶということがなされてきた。  
  
しかし，上に挙げた条件に当てはまらないデータの場合，当てはまる解析手法はあるだろうか？  
  
以降の章では，これまで学んできた統計手法を統計モデルという一つの枠組みで捉え直していく。
