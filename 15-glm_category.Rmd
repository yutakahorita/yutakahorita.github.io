
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(nnet)
library(ordinal)
library(knitr)
```

# 一般化線形モデル（複数カテゴリの分析）{#chap15_GLMCategory}

応答変数が2つのカテゴリの場合においては、ロジスティック回帰モデルを用いることを学んできた。では、応答変数が3つ以上のカテゴリの場合にはどのようなモデルを想定すればよいのだろうか。  
  
この章では更に一般化線形モデルの一部である順序ロジスティック回帰と多項ロジスティック回帰について学び、複数のカテゴリを持つ応答変数を扱う方法について理解していく。

-   順序ロジスティック回帰\
-   多項ロジスティック回帰

## 準備{#chap15_Preparation}

可視化のための`ggplot2`パッケージに加え、`ordinal`、`nnet`パッケージを使う。\
`ordinal`パッケージは順序ロジスティック回帰のときに、`nnet`パッケージは多項ロジスティック回帰のときに必要になる。初めて使う際には、事前にインストールが必要なので注意。

```{r, eval=FALSE}

library(ggplot2)
library(ordinal)
library(nnet)

```

## カテゴリカル変数の種類{#chap15_Variables}

第3章で、カテゴリカル変数は**順序尺度**と**名義尺度**に区別されることを学んだ。  
  
順序尺度とは、順序関係のあるカテゴリカル変数である。「優、良、可、不可」といった成績、「1. 賛成、2. どちらでもない、3. 反対」といった尺度などは順序尺度に該当する。順序関係はあるが、得点を用いて演算に用いることは出来ないので、変数の種類としては数値ではなくカテゴリカル変数である。  
  
名義尺度とは、順序関係のないカテゴリカル変数である（例：性別[男、女]、血液型、出身地など）。
  
順序ロジスティック回帰は応答変数が順序変数の場合、多項ロジスティック回帰は応答変数が名義尺度の場合に用いられる。


## 順序ロジスティック回帰{#chap15_OrderedLogistic}

### 例題{#chap15_CLMExample}

例えば、`Score`を試験の成績を意味する順序尺度として「1=不可、2=可、3=良、4=優、5=秀」の値を取るとする。この成績`Score`に対して、試験前日の睡眠時間`Sleep`が及ぼす影響を検討するとしよう。

```{r}

###サンプルデータの作成
Sleep = c(6,1,5,2,5,6,2,6,2,5,6,2,5,3,5,3,3,7,2,7,6,1,2,1,7,1,1,7,5,3)
Score = c(3,3,3,2,3,3,5,5,2,2,2,3,4,1,3,2,3,5,1,4,4,3,3,3,4,1,3,3,3,2)
sample_ordered = data.frame(Score = Score, Sleep = Sleep)
head(sample_ordered)

```

```{r}

ggplot2::ggplot() + 
  ggplot2::geom_jitter(data = sample_ordered, aes(x = Sleep, y = Score))

```


成績の得点は順序尺度なので、連続量として正規分布に従うという前提を置くのは適切ではない。二値のカテゴリカル変数の場合は二項分布を用いるロジスティック回帰で検討できたが、3つ以上のカテゴリを持つ変数の場合はどうすればよいか？


### 順序ロジスティック回帰モデルの詳細{#chap15_BasisCLM}

#### 累積確率と累積ロジット {.unnumbered}

順序のあるカテゴリカル変数を扱う場合には、**累積確率（cumulative
probability）**で各変数が生じる確率を表現する。累積確率とは、順序変数のある値以下が生じる確率のことをいう。例えば、$y$が$k$以下の値を取る累積確率を$Pr(y≤k)$と表現する。
カテゴリ$k$が生じる確率$p_{k}$とすると、$p_{k}$は累積確率を用いて以下の式で表現することができる。

$$
p_{k}=Pr(y≤k)−Pr(y≤k−1)
$$

例えば試験の成績（1=不可、2=可、3=良、4=優、5=秀）を$y$として考えると、$Pr(y≤3)$は、試験の成績が1,
2もしくは3である確率を示している。試験の成績が3である確率$p_{3}$は、累積確率$Pr(y≤3)$から累積確率$Pr(y≤2)$を引くことで求めることができる。

なお、カテゴリの最大値が出る確率は、全体の確率から引けば求まる。例えば、試験の成績が5である確率$p_{5}$は累積確率$Pr(y≤5)-Pr(y≤4)$を計算しなくとも、$1-Pr(y≤4)$で求めることができる。

#### 線形予測子との関係 {.unnumbered}

カテゴリ$k$が得られる累積確率$Pr(y ≤ k)$は、K-1個の切片$\alpha_{k}$で示すことができる（上で述べたように、最大カテゴリの確率は1から$Pr(y≤K-1)$を引けば求まるので、すべての確率を表現するために切片をK個用意する必要はない）。$\alpha_{k}$は累積確率を区切るポイントを意味し、*カットポイント(cutpoint)*とも呼ばれる。

$$
Pr(y≤k) = \frac{\exp(\alpha_{k})}{1+\exp(\alpha_{k})}
$$

更に、予測変数の効果（傾き）を考慮すると、累積確率は以下のように表現できる。

$$
\eta = \beta x\\
Pr(y ≤ k) = \frac{\exp(\alpha_{k} - \eta)}{1+\exp(\alpha_{k} - \eta)}
$$

以下のように書き換えることもできる（左辺を累積確率の対数オッズ、右辺を線形の式としたもの）。

$$
\eta = \beta x\\
\log\frac{Pr(y ≤ k)}{Pr(y > k)} = \alpha_{k} - \eta
$$

各切片から傾きの効果を引いているところに注意する必要がある。引くことによって、予測変数の値が大きいほど、累積確率の値が低くなる。言い換えれば、$Pr(y>k)$が大きくなる。つまり、傾きの効果を引くことによって、予測変数の値が大きくなるほど、より大きい値のカテゴリが生じる確率が大きくなることを表現できる。

このように、順序ロジスティック回帰のモデルでは、各カテゴリの累積確率を決定づける切片$\alpha_{k}$と傾き$\beta$を用いて、各カテゴリが生じる確率を推定する。

### Rでの順序ロジスティック回帰{#chap15_clm}

Rで順序ロジスティック回帰を行うには、外部パッケージの関数を利用する。以下では、`ordinal`パッケージに含まれている`clm`関数を使って、先ほど作成したサンプルデータ`sample_ordered`で順序ロジスティック回帰を行う。

### 変数の因子型への変換 {#chap15_factor}

解析の前に、Rで順序尺度を扱う場合は、変数を順序付きの因子型(factor)変数にする必要がある。`factor()`もしくは`ordered()`のいずれかの方法で作成する。

```{r}

#以下のいずれかの方法で因子型に変換する
sample_ordered$Score = factor(sample_ordered$Score, levels = c("1", "2", "3", "4", "5"), ordered = TRUE)
sample_ordered$Score = ordered(sample_ordered$Score, levels = c("1", "2", "3", "4", "5"))
#levelsで、水準の順序を指定する
#factor()では、オプションoredered=TRUEを加える

```

### 解析{#chap15_clm1}

応答変数を順序付きの因子型変数に変更したら、`ordinal`パッケージに含まれている`clm()`で解析する。`lm()`と同じ要領で、応答変数\~予測変数のモデルを書けば結果を出力してくれる。

```{r, eval = TRUE, include=FALSE}

model_polr = MASS::polr(data = sample_ordered, Score ~ 1 + Sleep, Hess = TRUE)
summary(model_polr)

```

```{r}

model_ordinal = ordinal::clm(data = sample_ordered, Score ~ 1 + Sleep)
summary(model_ordinal)

```

### 解釈{#chap15_clmOutput}

`Coefficients`に予測変数に係る傾きの係数の推定値が出力されている。傾きの解釈は、一般化線形モデルのときと同じである（累積確率の対数オッズの変化量：要は係数がプラスならば、予測変数は高順位のカテゴリが生じる確率を上昇させる効果を持つと解釈すれば良い）。`Intercepts`に出力されているのは、順序ロジスティック回帰モデルの各切片（カットポイント）の推定値である。

```{r, include=FALSE, eval = FALSE}

#***
#`polr()`ではp値を出力してくれないので、求めたい場合は自分で計算する必要がある。t値を元に、以下のプログラムで計算する。

coef_table = coef(summary(model_polr))
p = pnorm(abs(coef_table[,"t value"]), lower.tail = FALSE)*2
(cbind(coef_table, "p value" = p))

#***

```

## 多項ロジスティック回帰{#chap15_Multionom}

### 例題{#chap15_MultionomExample}

高校生が進学先（大学の学部）を選択する場合を例として考える。学部の種類（文学部、経済学部、理学部など）には順序関係はないので、学部の種類は名義尺度である。性別、高校のときの成績が学科選択に及ぼす影響を検討する。

```{r}
###サンプルデータの作成
set.seed(1)
Male = c(rep(0:1, 25))
Grade = rnorm(n=50, 5, 2)
Faculty = c(rep("Literature", 15), rep("Economics", 20), rep("Physical", 15))
sample_mnl = data.frame(Faculty = Faculty, Male = Male, Grade = Grade)
head(sample_mnl)

```

`Male`は性別（男=1,
女=0）、`Grade`は高校の時の成績、`Faculty`は志望学部を意味する変数とする。`Faculty`には、`Literature`（文学部）、`Economics`（経済学部）、`Physical`（理学部）の3種類のカテゴリがあるとする。  
  
先ほどの成績（1=不可、2=可、3=良、4=優、5=秀）の例とは異なり、今回の予測の対象となる応答変数は順序関係のないカテゴリカル変数（名義尺度）であった。順序関係がないカテゴリカル変数の場合はどうすればよいか？\


### 多項ロジスティック回帰モデルの詳細{#chap15_BasisMultinom}

多項ロジスティック回帰では基準となるカテゴリを設定し、基準カテゴリと比べて各カテゴリが生じやすいかを推定する複数のモデルを設定する。

例えば、経済学部(Economics)を基準カテゴリとする。他のカテゴリ(Literature,
Physical)が生じる確率を線形の式で表した例を以下に示す。

$$
\log\frac{Pr(Literature)}{Pr(Economics)}= \alpha_{1} + \beta_{1,1} Male + \beta_{2,1} Grade \\
\log\frac{Pr(Physical)}{Pr(Economics)}= \alpha_{2} + \beta_{1,2} Male + \beta_{2,2} Grade \\
$$

多項ロジスティック回帰では、カテゴリごとに異なる線形予測子を設定し、それぞれ異なる切片と傾きの値を推定する。

### Rでの多項ロジスティック回帰{#chap15_nlm}

Rには多項ロジスティック回帰を行うための関数として、`nnet`パッケージの`multinom()`関数がある。`lm()`と同じ要領でモデルを記述すると、推定結果を出力してくれる。先ほど作ったサンプルデータ`sample_mnl`で、多項ロジスティック回帰を行ってみる。

```{r, message=FALSE, warning=FALSE}

result_mnl = nnet::multinom(data = sample_mnl, Faculty ~ 1 + Male + Grade)
summary(result_mnl)

```

`Coeffficients`の部分に、係数の推定結果が出力される。このモデルでは`Economics`が基準カテゴリとなっている（デフォルトで、アルファベット順で一番はじめに出てくるカテゴリが基準となる）。`Literature`の部分に出力されるのが上の式でいう$\alpha_{1}$,
$\beta_{1, 1}$,
$\beta_{2, 1}$に、`Physical`の部分に出力されるのが$\alpha_{2}$,
$\beta_{1, 2}$, $\beta_{2, 2}$に相当する。

`Literature`の予測変数の傾きの推定値は、基準カテゴリ（`Economics`）と比べた上でのその予測変数の効果を意味する（その予測変数が1単位変化したときの`Literature`と`Economics`の対数オッズの変化量）。

このように、多項ロジスティック回帰の係数はある基準カテゴリと比較した上での効果を意味するため、解釈は複雑になる。

------------------------------------------------------------------------

`multinom()`ではp値を出力してくれないので、求めたい場合は自分で計算する必要がある。以下には、z
scoreを元に計算する方法を示す。

```{r}

#p値の出力
z = summary(result_mnl)$coefficients/summary(result_mnl)$standard.errors
p = (1 - pnorm(abs(z), mean = 0, sd = 1)) * 2
p

```


